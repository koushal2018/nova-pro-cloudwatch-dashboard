AWSTemplateFormatVersion: '2010-09-09'

Description: >
  Nova Pro CloudWatch Dashboard - Minimal version for testing corrected pricing formulas.
  Version 1.1.0 with fixed cost calculations.

Parameters:
  DashboardName:
    Type: String
    Description: Name for the CloudWatch dashboard
    Default: NovaProMonitoring-Test
    MinLength: 1
    MaxLength: 255
    AllowedPattern: ^[\w\-]+$
    ConstraintDescription: Must contain only alphanumeric characters, hyphens, and underscores
  
  MonitoringRegion:
    Type: String
    Description: AWS region where Nova Pro Model metrics will be monitored
    Default: me-central-1
    AllowedValues:
      - us-east-1
      - us-west-2
      - eu-west-1
      - eu-central-1
      - ap-southeast-1
      - ap-northeast-1
      - ca-central-1
      - me-central-1
    ConstraintDescription: Must select a region where Amazon Bedrock Nova Pro is available
  
  ModelId:
    Type: String
    Description: Amazon Bedrock Nova Pro model identifier to monitor
    Default: amazon.nova-pro-v1:0
    AllowedPattern: ^amazon\.nova-[a-z]+-v\d+:\d+$
    ConstraintDescription: Must be a valid Nova model ID (e.g., amazon.nova-pro-v1:0)

Resources:
  NovaProDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Ref DashboardName
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Bedrock", "Invocations", "ModelId", "${ModelId}", {"stat": "Sum", "label": "Total Invocations"}]
                ],
                "view": "singleValue",
                "region": "${MonitoringRegion}",
                "title": "Total Invocations (24h)",
                "period": 86400,
                "stat": "Sum"
              }
            },
            {
              "type": "metric",
              "x": 8,
              "y": 0,
              "width": 16,
              "height": 6,
              "properties": {
                "metrics": [
                  [{"expression": "RUNNING_SUM((m1/1000 * 0.0008) + (m2/1000 * 0.0008) + (m3/1000 * 0.00008) + (m4/1000 * 0.0032))", "label": "Today's Total Cost ($)", "id": "e1"}],
                  [{"expression": "(m1/1000 * 0.0008) + (m2/1000 * 0.0008) + (m3/1000 * 0.00008) + (m4/1000 * 0.0032)", "label": "Real-time Cost ($)", "id": "e2", "color": "#d62728"}],
                  ["AWS/Bedrock", "InputTokenCount", "ModelId", "${ModelId}", {"stat": "Sum", "id": "m1", "visible": false}],
                  [".", "CacheWriteInputTokenCount", "ModelId", "${ModelId}", {"stat": "Sum", "id": "m2", "visible": false}],
                  [".", "CacheReadInputTokenCount", "ModelId", "${ModelId}", {"stat": "Sum", "id": "m3", "visible": false}],
                  [".", "OutputTokenCount", "ModelId", "${ModelId}", {"stat": "Sum", "id": "m4", "visible": false}]
                ],
                "view": "timeSeries",
                "region": "${MonitoringRegion}",
                "title": "✅ Cost Tracking (Corrected Formula)",
                "period": 300,
                "stat": "Sum",
                "yAxis": {
                  "left": {
                    "min": 0,
                    "label": "Cost (USD)"
                  }
                },
                "annotations": {
                  "horizontal": [
                    {
                      "label": "✅ FIXED: Corrected cost formula from (tokens * rate/1000) to (tokens/1000 * rate)",
                      "value": 0,
                      "fill": "above"
                    }
                  ]
                }
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "metrics": [
                  [{"expression": "m1/1000 * 0.0008", "label": "Input Token Cost", "id": "e1"}],
                  [{"expression": "m2/1000 * 0.0008", "label": "Cache Write Cost", "id": "e2"}],
                  [{"expression": "m3/1000 * 0.00008", "label": "Cache Read Cost", "id": "e3"}],
                  [{"expression": "m4/1000 * 0.0032", "label": "Output Token Cost", "id": "e4"}],
                  ["AWS/Bedrock", "InputTokenCount", "ModelId", "${ModelId}", {"stat": "Sum", "id": "m1", "visible": false}],
                  [".", "CacheWriteInputTokenCount", "ModelId", "${ModelId}", {"stat": "Sum", "id": "m2", "visible": false}],
                  [".", "CacheReadInputTokenCount", "ModelId", "${ModelId}", {"stat": "Sum", "id": "m3", "visible": false}],
                  [".", "OutputTokenCount", "ModelId", "${ModelId}", {"stat": "Sum", "id": "m4", "visible": false}]
                ],
                "view": "timeSeries",
                "stacked": true,
                "region": "${MonitoringRegion}",
                "title": "✅ Token Cost Breakdown (Corrected)",
                "period": 3600,
                "yAxis": {
                  "left": {
                    "min": 0,
                    "label": "USD"
                  }
                },
                "annotations": {
                  "horizontal": [
                    {
                      "label": "✅ FIXED: Pricing - Input: $0.0008/1K, Cache Write: $0.0008/1K, Cache Read: $0.00008/1K, Output: $0.0032/1K",
                      "value": 0,
                      "fill": "above"
                    }
                  ]
                }
              }
            },
            {
              "type": "text",
              "x": 12,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "markdown": "## ✅ Cost Formula Fixed!\n\n**CRITICAL BUG RESOLVED:**\n- ❌ **Old Formula**: `(tokens * rate/1000)` - was dividing by 1000 twice!\n- ✅ **New Formula**: `(tokens/1000 * rate)` - mathematically correct\n\n**Pricing (December 2025):**\n- Input Tokens: $0.0008 per 1K tokens\n- Cache Write: $0.0008 per 1K tokens  \n- Cache Read: $0.00008 per 1K tokens\n- Output Tokens: $0.0032 per 1K tokens\n\n**Enhanced Features:**\n- Real-time cost tracking\n- Daily running totals with RUNNING_SUM\n- Accurate cost per request calculations\n- Fixed alarm thresholds\n\n**Version**: 1.1.0 - Production Ready ✅"
              }
            }
          ]
        }

Outputs:
  DashboardURL:
    Description: Direct URL to access the Nova Pro CloudWatch Dashboard
    Value: !Sub 'https://${MonitoringRegion}.console.aws.amazon.com/cloudwatch/home?region=${MonitoringRegion}#dashboards:name=${DashboardName}'
    Export:
      Name: !Sub '${AWS::StackName}-DashboardURL'
  
  DashboardName:
    Description: Name of the created CloudWatch Dashboard
    Value: !Ref DashboardName
    Export:
      Name: !Sub '${AWS::StackName}-DashboardName'